name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

permissions:
  contents: read
  pull-requests: write

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build
      run: dotnet build --no-restore --configuration Release
      
    - name: Run Unit Tests
      run: dotnet test tests/ObjMapper.Tests/ObjMapper.Tests.csproj --no-build --configuration Release --verbosity normal --collect:"XPlat Code Coverage" --results-directory ./coverage
      
    - name: Upload coverage artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage
        path: ./coverage
        retention-days: 5
      
    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v5
      with:
        directory: ./coverage
        fail_ci_if_error: false
        verbose: true
        token: ${{ secrets.CODECOV_TOKEN }}

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test
          MYSQL_DATABASE: testdb
          MYSQL_USER: test
          MYSQL_PASSWORD: test
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          ACCEPT_EULA: Y
          SA_PASSWORD: Test@12345
          MSSQL_PID: Express
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P Test@12345 -Q 'SELECT 1' -C"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build
      run: dotnet build --no-restore --configuration Release
      
    - name: Wait for SQL Server
      run: |
        for i in {1..30}; do
          /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P Test@12345 -Q "SELECT 1" -C && break || sleep 2
        done
      continue-on-error: true
      
    - name: Run Integration Tests
      run: dotnet test tests/ObjMapper.IntegrationTests/ObjMapper.IntegrationTests.csproj --no-build --configuration Release --verbosity normal --collect:"XPlat Code Coverage" --results-directory ./coverage-integration
      env:
        POSTGRES_CONNECTION: "Host=localhost;Database=testdb;Username=test;Password=test"
        MYSQL_CONNECTION: "Server=localhost;Database=testdb;User=test;Password=test"
        SQLSERVER_CONNECTION: "Server=localhost;Database=master;User Id=sa;Password=Test@12345;TrustServerCertificate=True"
        
    - name: Upload integration test coverage artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage-integration
        path: ./coverage-integration
        retention-days: 5
        
    - name: Upload integration test coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        directory: ./coverage-integration
        fail_ci_if_error: false
        verbose: true
        token: ${{ secrets.CODECOV_TOKEN }}

  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [build, integration-tests]
    if: always() && github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Install ReportGenerator
      run: dotnet tool install -g dotnet-reportgenerator-globaltool
      
    - name: Download unit test coverage
      uses: actions/download-artifact@v4
      with:
        name: coverage
        path: ./coverage
      continue-on-error: true
      
    - name: Download integration test coverage
      uses: actions/download-artifact@v4
      with:
        name: coverage-integration
        path: ./coverage-integration
      continue-on-error: true
      
    - name: Merge coverage reports
      run: |
        mkdir -p ./coverage-merged
        reportgenerator \
          -reports:"./coverage/**/coverage.cobertura.xml;./coverage-integration/**/coverage.cobertura.xml" \
          -targetdir:"./coverage-merged" \
          -reporttypes:"Cobertura;MarkdownSummaryGithub" \
          -verbosity:Warning
      continue-on-error: true
      
    - name: Generate coverage summary
      run: |
        echo "## Code Coverage Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f "./coverage-merged/SummaryGithub.md" ]; then
          cat ./coverage-merged/SummaryGithub.md >> $GITHUB_STEP_SUMMARY
        else
          echo "Coverage reports have been uploaded to Codecov." >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Add Coverage PR Comment
      uses: marocchino/sticky-pull-request-comment@v2
      if: github.event_name == 'pull_request'
      with:
        recreate: true
        path: coverage-merged/SummaryGithub.md
      continue-on-error: true
