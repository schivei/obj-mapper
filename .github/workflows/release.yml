name: Release

on:
  push:
    tags:
      - 'v*'
  release:
    types:
      - created
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (ex: v1.2.3). If vazio, será usado o tag do release ou o tag do push quando disponível.'
        required: false
        default: ''

permissions:
  contents: write  # Required for creating releases

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  release:
    name: Build and Publish
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for creating releases
    
    steps:
    - name: Checkout
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        
    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Get version from tag
      id: get_version
      env:
        INPUT_TAG: ${{ github.event.inputs.tag }}
        RELEASE_TAG: ${{ github.event.release.tag_name }}
        REF_TAG: ${{ github.ref_name }}
      run: |
        # Prioridade:
        # 1) input informado manualmente via workflow_dispatch (INPUT_TAG)
        # 2) tag do release (RELEASE_TAG)
        # 3) ref name (REF_TAG) — quando workflow disparado por push de tag
        if [ -n "${INPUT_TAG}" ]; then
          TAG="${INPUT_TAG}"
        elif [ -n "${RELEASE_TAG}" ]; then
          TAG="${RELEASE_TAG}"
        elif [ -n "${REF_TAG}" ]; then
          TAG="${REF_TAG}"
        else
          echo "Nenhuma tag fornecida ou detectada (use o input 'tag' ao executar manualmente)." >&2
          exit 1
        fi

        # Salva a tag original (pode conter o prefixo "v")
        RAW_TAG="$TAG"

        # Remover prefixo "v" se existir (tags como v1.2.3)
        TAG="${TAG#v}"

        # Parse version components (prefix e optional suffix após '-')
        if [[ $TAG == *-* ]]; then
          VERSION_PREFIX=$(echo "$TAG" | cut -d'-' -f1)
          VERSION_SUFFIX=$(echo "$TAG" | cut -d'-' -f2-)
        else
          VERSION_PREFIX=$TAG
          VERSION_SUFFIX=""
        fi

        echo "RAW_TAG=$RAW_TAG" >> $GITHUB_OUTPUT
        echo "VERSION_PREFIX=$VERSION_PREFIX" >> $GITHUB_OUTPUT
        echo "VERSION_SUFFIX=$VERSION_SUFFIX" >> $GITHUB_OUTPUT
        echo "FULL_VERSION=$TAG" >> $GITHUB_OUTPUT
        
    - name: Restore dependencies
      run: dotnet restore
      
    - name: Build
      run: dotnet build --no-restore --configuration Release -p:VersionPrefix=${{ steps.get_version.outputs.VERSION_PREFIX }} -p:VersionSuffix=${{ steps.get_version.outputs.VERSION_SUFFIX }}
      
    - name: Run Tests
      run: dotnet test --no-build --configuration Release --verbosity normal
      
    - name: Pack
      run: dotnet pack src/ObjMapper/ObjMapper.csproj --no-build --configuration Release -p:VersionPrefix=${{ steps.get_version.outputs.VERSION_PREFIX }} -p:VersionSuffix=${{ steps.get_version.outputs.VERSION_SUFFIX }} -o ./nupkg
      
    - name: Push to NuGet
      run: dotnet nuget push ./nupkg/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

    - name: Check if release exists
      id: check_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        FULL_VERSION: ${{ steps.get_version.outputs.FULL_VERSION }}
        RAW_TAG: ${{ steps.get_version.outputs.RAW_TAG }}
      run: |
        # Verifica tanto a tag sem 'v' quanto com 'v' (ex.: "1.2.3" e "v1.2.3")
        TAGS_TO_CHECK=()
        if [ -n "$RAW_TAG" ]; then
          TAGS_TO_CHECK+=("$RAW_TAG")
        fi
        if [ -n "$FULL_VERSION" ]; then
          TAGS_TO_CHECK+=("$FULL_VERSION")
          TAGS_TO_CHECK+=("v$FULL_VERSION")
        fi

        exists=false
        for t in "${TAGS_TO_CHECK[@]}"; do
          if [ -z "$t" ]; then
            continue
          fi
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" "https://api.github.com/repos/$GITHUB_REPOSITORY/releases/tags/$t")
          if [ "$STATUS" = "200" ]; then
            echo "Found existing release for tag '$t' (HTTP $STATUS)"
            exists=true
            break
          fi
        done

        echo "exists=$exists" >> $GITHUB_OUTPUT

    - name: Skip creating release (already exists)
      if: steps.check_release.outputs.exists == 'true'
      run: echo "Release for tag ${{ steps.get_version.outputs.RAW_TAG }} / ${{ steps.get_version.outputs.FULL_VERSION }} already exists — skipping Create GitHub Release step."

    - name: Create GitHub Release
      if: steps.check_release.outputs.exists != 'true'
      uses: softprops/action-gh-release@v2
      with:
        files: ./nupkg/*.nupkg
        generate_release_notes: true
        prerelease: ${{ contains(steps.get_version.outputs.FULL_VERSION, '-') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
